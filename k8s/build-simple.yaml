apiVersion: v1
kind: Pod
metadata:
  name: repomind-builder
spec:
  restartPolicy: Never
  containers:
  - name: builder
    image: docker:24-dind
    securityContext:
      privileged: true
    env:
    - name: DOCKER_TLS_CERTDIR
      value: ""
    command: ['sh', '-c']
    args:
    - |
      # Start dockerd
      dockerd-entrypoint.sh &
      sleep 10
      
      # Wait for source tar
      echo "Waiting for source code..."
      while [ ! -f /workspace/source.tar.gz ]; do
        sleep 2
      done
      
      # Extract source
      cd /workspace
      tar -xzf source.tar.gz
      
      # Build image
      docker build -t repomind:latest .
      
      # Save image
      docker save repomind:latest -o /workspace/repomind-image.tar
      
      echo "Build complete! Image saved to /workspace/repomind-image.tar"
      sleep 3600
    volumeMounts:
    - name: workspace
      mountPath: /workspace
  volumes:
  - name: workspace
    emptyDir: {}




